<!DOCTYPE html>
<html lang="pt-br">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-Procrastinator — Painel</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>

<body>

<header>
    <h2>Olá, {{ request.user.username }}</h2>

    <div class="xp-box glass">
        <strong>Level {{ level }}</strong> — {{ xp }} XP
        <div class="bar"><div id="barFill" class="bar-fill"></div></div>
        <p class="xp-info">Faltam <span id="xpToNext">{{ xp_to_next }}</span> XP para o próximo nível</p>
    </div>

    <a class="logout" href="{% url 'logout' %}">Sair</a>
</header>

<div class="container">

    <!-- Form de adicionar tarefa -->
    <div class="card glass">
        <h3>Adicionar Tarefa</h3>

        <form method="POST">
            {% csrf_token %}

            <input type="text" name="titulo" placeholder="Título da tarefa" required>
<textarea name="descricao" rows="2" placeholder="Descrição (opcional)" class="limit-box"></textarea>

            <div class="select-container">
    <select name="dificuldade">
        <option value="M" >Média — 20 XP</option>
        <option value="D">Difícil — 40 XP</option>
        <option value="F">Fácil — 10 XP</option>
    </select>
</div>


            <button class="btn primary-btn" name="add" type="submit">Adicionar</button>
        </form>
    </div>

    <!-- Abas -->
    <div class="tabs">
        <a class="tab {% if tab == 'ativas' %}active{% endif %}" href="?tab=ativas">Ativas</a>
        <a class="tab {% if tab == 'concluidas' %}active{% endif %}" href="?tab=concluidas">Concluídas</a>
        <a class="tab {% if tab == 'lixeira' %}active{% endif %}" href="?tab=lixeira">Lixeira</a>
    </div>

    <!-- Lista de tarefas -->
    <div class="card glass">

        {% if tarefas %}
            {% for tarefa in tarefas %}
            
            <div class="task">

                <div>
                    <h3 class="task-title">{{ tarefa.titulo }}</h3>
                    <p class="task-desc">{{ tarefa.descricao }}</p>
                    <span class="difficulty {{ tarefa.dificuldade }}">{{ tarefa.get_dificuldade_display }}</span>
                </div>

                <div class="task-buttons">

    {% if tab == 'lixeira' %}

        <!-- EXCLUIR DEFINITIVO -->
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
            <button class="btn delete-btn" name="force_delete">Excluir</button>
        </form>

        <!-- RESTAURAR -->
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
            <button class="btn restore-btn" name="restore">Restaurar</button>
        </form>

    {% else %}

        {% if not tarefa.concluida and not tarefa.is_deleted %}
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
            <button class="btn primary-btn" name="done">Concluir</button>
        </form>
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="tarefa_id" value="{{ tarefa.id }}">
            <button class="btn delete-btn" name="delete">Excluir</button>
        </form>

    {% endif %}

</div>


            </div>

            {% endfor %}
        {% else %}
            <p>Nenhuma tarefa aqui.</p>
        {% endif %}

    </div>

</div>

<script>
    const xp = Number("{{ xp }}");
    const needed = Number("{{ xp_needed_for_level }}");

    const percent = Math.min(100, Math.round((xp / needed) * 100));
    document.getElementById("barFill").style.width = percent + "%";
</script>

</body>
</html>
